---
title: "HTTP版本演进"
date: 2022-01-05T22:31:50+08:00
categories: ["技术分享"]
tags: ["计算机网络"]
---

## http各版本结构

![image-20220105210151444](https://tva1.sinaimg.cn/large/008i3skNly1gy33i7adanj31gy0p6gpt.jpg)

## http/1.1

### http/1.1的优点

1. 简单
2. 灵活易扩展
3. 应用广泛和跨平台

### http/1.1缺点

1. 无状态【双刃剑】。简单解决方案：cookie
2. 明文传输【双刃剑】
3. 不安全
   1. 通信使用明文，内容可能会被窃听【窃听】
   2. 不验证通信方的身份，可能遭遇伪装【冒充】
   3. 无法证明报文的完整性，可能已遭篡改【篡改】

### 对比http/1.0 和 http/1.1

http/1.1 相对 http/1.0 的改进：

- 使用TCP长连接的方式改善了 http/1.0 短连接造成的性能开销。http1.0对每个请求都要新建TCP连接。
- 支持管道（pipeline）网络传输，允许浏览器同时发送多个请求，但服务器还是要按顺序返回。可减少整体的响应时间。

但http/1.1还有的性能瓶颈有：

- 请求/响应头部（Header）未经压缩就发送，首部信息越多延迟越大，只能压缩 Body 的部分。
- 发送冗长的首部。每次相互发送相同的首部造成的浪费较多。
- 服务器是按请求顺序响应的，如果服务器响应慢，会导致客户端一直请求不到数据，即**队头阻塞**。
- 有没请求优先级控制。
- 请求只能从客户端开始，服务器只能被动响应。

## https

### https解决的http问题

- 窃听风险：信息加密，混合加密
  - 在通信建立前采用非对称加密的方式交换【会话密钥】。
  - 在通信过程中全部使用对称加密的方式使用【会话密钥】加密明文数据（明文加摘要）。
- 篡改风险：校验机制，通过摘要算法保证完整性
- 冒充风险：身份证书，将公钥放入到数字证书中。
  - 客户端要先向服务端索要公钥，然后用公钥加密信息，如何保证公钥不被篡改？借助第三方权威机构CA（数字证书认证机构），将服务器公钥放在数字证书中，只要证书是可信的，公钥就是可信的。

通过在http与tcp层之间加入了 `SSL/TLS` 协议实现。

#### SSL和TLS

二者实际上是一个东西，是同一东西不同阶段的名字。

SSL（Secure Sockets Layer）中文套接字，上世纪90年代出现的。

由于SSL应用广泛，便把SSL标准化，标准化之后的名称为TLS（Transport Layer Security）传输层安全协议。

很多文章习惯把二者并列写为SSL/TLS。

### http 和 https传输过程的差异

建立连接时：https比http多了TLS握手过程。

传输内容时：https会对数据进行对称加密。

### https是如何建立连接的？

SSL/TLS 协议基本流程：

- 客户端向浏览器索要并验证服务器的公钥。
- 通过非对称加密传递【会话密钥】
- 双方采用【会话密钥】进行加密通信。

前两步就是 SSL/TLS 的建立工程，也就是握手阶段。



TLS1.2需要4次握手，需要两个RTT往返时延。

TLS1.3只需要3次握手，只需要1个RTT往返时延。

![image-20220105221940553](https://tva1.sinaimg.cn/large/008i3skNly1gy35r34dqfj312u0o2gnj.jpg)

![image-20220105222007420](https://tva1.sinaimg.cn/large/008i3skNly1gy35rjxw7qj317m0s4wh4.jpg)

## http/2 的优化

http/2 协议是基于https的，所以安全性也是有保障的。

http/2 改进点：

- 头部压缩
  - http/2会压缩头（Header）。如果你同时发出多个请求，他们的头是一样的或是相似的，协议就会帮你消除重复的部分。
  - 采用了 `HPACK` 算法：在客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送相同的字段，发送索引号，提高速度。
- 二进制格式报文：header 和 body 都是二进制，并且统称为帧
  ![image-20220105213758152](https://tva1.sinaimg.cn/large/008i3skNly1gy34jpxk19j31500ma0ug.jpg)

- 数据流
  - Http/2的数据包不是按顺序发送的，同一个连接里面连续的数据包，可能属于不同的响应。因此，必须要对数据包进行标记，指出它属于哪个响应。
  - 每个请求或响应的所有数据包，称为一个数据流（`Stream`）。每个数据流都标记着一个独一无二的编号，其中规定客户端发出的数据流编号为奇数，服务器发出的数据流编号为偶数。
  - 客户端还可以指定数据流的优先级。优先级高的请求，服务器优先响应。
- 多路复用
  - http/2 可以在一个连接中并发多个请求或响应，而不用按照顺序一一对应。移除了http/1.1中的串行请求，不会出现队头阻塞的问题，降低了延迟，提高了连接的利用率。
- 服务器推送（Server Push/Cache Push）：服务器可以主动向客户端发送消息。如：在浏览器刚请求html时，就提前把可能会用到的js、css等静态文件主动发送给客户端，减少延时的等待。

## http/3 的优化

http/2的主要问题在于，多个http请求复用一个tcp连接，下层的tcp协议不知道有多少个http请求。一旦发生了丢包，就会触发tcp的重传机制，那么在同一个tcp连接下的http请求就都必须重新等待这个丢的包被重传回来。

- http/3 把下层的tcp协议改成了udp。
  - udp是不管顺序，不管丢包的。所以不会出现队头阻塞和一个丢包全部重传的问题。
  - udp是不可靠传输，但基于udp的`QUIC`协议可以实现类似tcp的可靠传输。
- TLS升级成了最新的1.3版本
- 头部压缩算法升级成了 `QPack`

### QUIC

QUIC通过自己的一套机制保证可靠传输。当某个流发生丢包时，只会阻塞这个流，其他流不会受到影响。

https要建立一个连接，要花费6次交互，TCP的3次握手+TLS1.3的三次握手。QUIC直接把TCP和TLS1.3的6次交互合并成了3次，减少了交互次数。

QUIC是一个建立在UDP之上的 伪TCP + TLS + HTTP/2 的多路复用协议。

由于QUIC是新协议，对于很多网络设备，不知道什么是QUIC，只会当做UDP，会导致新的问题出现，所以HTTP/3的普及进度是否缓慢。

![image-20220105220129920](https://tva1.sinaimg.cn/large/008i3skNly1gy3586dhytj316i0u0tcb.jpg)

