---
title: "IP层概述"
date: 2022-01-11T22:23:10+08:00
categories: ["技术分享"]
tags: ["计算机网络"]
---

# IP

网络层（IP）的主要作用是：实现主机与主机之间的通信，点到点（end to end）的通信。

数据链路层（MAC）的作用是实现**直连**的两个设备之间通信，网络层（IP）则负责在**没有直连**的两个网络之间通信。

源IP地址和目标IP地址在传输过程中是不变的，源MAC地址和目标MAC一直在变化。

![image-20220111205726945](https://tva1.sinaimg.cn/large/008i3skNly1gya13dl0xsj31gq0qktcf.jpg)

IP地址并不是根据主机数量来分配的，而是根据网卡。像服务器、路由器等设备都是有2个以上的网卡，就会有2个以上的IP地址。

## IP地址的分类

### 分类地址

最开始是分类地址，分类A、B、C、D、E五类。

A、B、C类，分为网络号加主机号。

D类为组播（多播）地址。用于将包发送给塔顶组内的所有主机。由于广播无法穿透路由，若想给其他网段发送同样的包，就可以使用穿透路由的组播。

E类为备用。



主机号全为1指定某个网络下的所有主机，用于广播。

主机号全为0指定某个网络。



广播地址分为：

本地广播：在本网络内的广播

直接广播：在不同网络之间的广播



分类地址的优点：简单明了、选路简单。

分类地址的缺点：同一网络下没有地址层次，不够灵活。不能很好的与需求匹配。

### CIDR无分类地址

CIDR无分类地址可以解决分类地址的问题。

CIDR无分类地址将32比特的IP地址分为两部分，网络号+主机号。

表示形式`a.b.c.d/x`，`/x`表示前面x位是网络号。

还有另一种划分网络号和主机号的方式，使用子网掩码。子网掩码还有一个作用，就是划分子网。将主机号分为：子网网络地址+子网主机地址。



---

为什么要分离网络号和主机号？

因为两台计算机要通讯，首先要判断是否处于同一个广播域内，即网络号是否相同。如果相同，可以直接把数据报发送到目标主机。



IP地址的网络地址是用于进行路由控制的。

路由控制表记中记录着网络地址与下一步应该发送至路由器的地址。主机和路由器都有各自的路由控制表。

如果路由控制表中有多条相同的网络地址记录，选择相同位数最多的网络地址，即最长匹配。



计算机使用一个特殊的IP地址 `127.0.0.1`作为环回地址。与该地址具有相同意义的主机名是`localhost`。使用这个IP或主机名时，数据包不会流向网络。



经过分片后的IP数据报在被重组时，只能由目标主机进行，路由器是不会进行重组的。

在分片传输中，一旦某个分片丢失，则会造成整个IP数据报作为，所以TCP引入了MSS也就是在TCP进行分片不由IP分片。而对于UDP我们尽量不要发送一个大于MTU的数据报文。

## IPv6

IPv4是32位的。

IPv6是128位的。以每16位一组，每组用冒号`:`隔开。常用16进制表示。

![image-20220111212520216](https://tva1.sinaimg.cn/large/008i3skNly1gya1we8yb4j31gi0i0n0n.jpg)

IPv4和IPv6不能相互兼容。



IPv6优点：

- 可自动配置，几时没有DHCP服务器也可以实现自动分配IP。
- 首部采用固定值40字节，去掉了校验和，简化了首部结构。
- 安全性提升。有对应伪造IP地址的网络安全功能以及防止线路窃听的功能。

## DNS

DNS域名解析，将域名转化为IP地址。

在域名中，越靠右的表示层级越高。



域名层级：

- 根DNS服务器
- 顶级域DNS服务器（com）
- 权威DNS服务器（server.com）



域名解析工作流程：

1. 流浪器首先看自己的缓存里有没有，没有就向操作系统的缓存要，还有没就检查本地域名解析文件`hosts`，还没有就想DNS服务器进行查询。
2. 客户端发送一个DNS请求，先发给本地DNS服务器（客户端的TCP/IP设置中填写的DNS服务器地址）。
3. 本地域名服务器收到客户端请求后，如果缓存中有，就直接返回IP。如有没，本地DNS会向根域名服务器询问。
4. 根会告知客户端是属于哪个顶级域名服务器。
5. 本地DNS收到顶级域名服务器地址后，向其发起请求。
6. 顶级域名服务器会告知属于哪个权威DNS服务器。
7. 本地DNS向权威DNS服务器询问，得到IP地址。
8. 本地DNS将IP地址返回给客户端。

![image-20220111213659323](https://tva1.sinaimg.cn/large/008i3skNly1gya28ilwxsj315m0u078n.jpg)

## ARP

由IP地址得到MAC地址。

借助ARP请求（发送广播询问）与ARP响应确定MAC地址。

## RARP

由MAC地址得到IP地址。

## DHCP

动态获取IP地址，省去了配IP的繁琐过程。

DHCP的交互中，全程都是使用UDP广播通信。

## NAT

为了缓解IPv4地址空间不足的情况。通过NAT网络地址转换，将公网IP和私网IP进行转换。

由于大多数网络应用都是使用TCP或UDP传输，因此可以IP地址+端口号一起进行转换，这种转换技术叫网络地址与端口转换NAPT。

使用IPv6的话就不用使用NAT了。

NAT穿透技术：客户端主动从NAT设备获取公有IP地址，然后自己建立端口映射条目，然后用这个条目对外通信，就不需要NAT设备来进行转换了。

## ICMP

ICMP Internet Control Message Protocal，互联网控制报文协议。

ICMP报文是封装在IP包里，工作在网络层。

![image-20220111214909032](https://tva1.sinaimg.cn/large/008i3skNly1gya2l63xzvj30t209c0t6.jpg)

ICMP分为两类：

- 查询报文类型：用于诊断的查询信息。eg：ping。
- 差错报文类型：通知出错原因的错误信息。eg：tracerouter。

![image-20220111214702326](https://tva1.sinaimg.cn/large/008i3skNly1gya2iz3g67j31680u0gq5.jpg)

## IGMP

IGMP是因特网组管理协议，工作在主机（组播成员）和最后一跳路由之间。
